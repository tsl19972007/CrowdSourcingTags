<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1,minimum-scale=1.0, maximum-scale=1",user-scalable=no>
    <title>分块发布</title>
    <link href="css/zzsc.css" rel="stylesheet">
    <link href="css/maps.css" rel="stylesheet">
    <link href="fonts/css/font-awesome.css" rel="stylesheet">
    <link href="fonts/fonts/fontawesome-webfont.ttf" rel="stylesheet">
    <link href="fonts/fonts/fontawesome-webfont.woff" rel="stylesheet">
    <link href="fonts/fonts/fontawesome-webfont.woff2" rel="stylesheet">
    <link rel="stylesheet" href="css/openpublish_style.css">
    <link href="css/message.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="js/maps.js"></script>
    <script type="text/javascript" src="js/google.js"></script>
    <script type="text/javascript" src="js/message.js"></script>
    <script type="text/javascript" src="js/vue.min.js"></script>
    <script src="js/sweetalert.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/sweetalert.css">
    <script type="text/javascript">$(document).ready(function(){$().maps();});</script>
    <script type="text/javascript">$(function (){
        $('#nky2 li:not(#nky2 li:last)').click(function (){
            $('.active').removeClass('active');
            $(this).addClass("active");
        });
        $('.venus-menuM li').click(function(){
            $('.venus-menuM li.active').removeClass('active');
            $(this).addClass("active");
            var mode=document.getElementById('read').innerText;
            document.getElementById('read').innerText=(mode=='全部标为已读')?'删除已读':'全部标为已读';
            if(mode=="全部标为已读"){
                document.getElementById('read').innerText='删除已读';
                refreshRead();
            }
            else{
                document.getElementById('read').innerText='全部标为已读';
                refreshNew();
            }
        });
    })
    </script>
    <script type="text/javascript" src="js/open1.js"></script> <!--导入图片的实现-->
    <script type="text/javascript" src="js/open2.js"></script>
    <script type="text/javascript" src="js/open3.js"></script>
    <script>
        window.onload=function(){
            read1();
            read2();
            read3();
        }
    </script>
    <style>
         .content>ul>li:last-child>ul>li>a{
            width:300px;
            font-size:10px;
            float:right;
         }
    </style>
</head>

<body>

<div style="text-align:center;clear:both">
    <script src="/gg_bd_ad_720x90.js" type="text/javascript"></script>
    <script src="/follow.js" type="text/javascript"></script>
</div>

<div class="content">
    <ul id="nky2" class="venus-menu">
        <li><a href="employer-home"><i class="icon-home"></i>主页</a></li>
        <li><a href="#"><i class="icon-user"></i>个人</a>
            <ul>
                <li><a href="employer-info">个人信息</a></li>
                <li><a href="employer-data">统计信息</a></li>
            </ul></li>
        <li class="active"><a href="#"><i class="icon-tasks"></i>任务</a><ul>
            <li><a href="#">发布新任务</a><ul>
                <li><a href="openPublication">自由发布</a></li>
                <li><a href="specifiedPublication">指派发布</a></li>
                <li><a href="cutPartPublication">分块发布</a></li>
            </ul>
            <li><a href="employer-underway">进行中任务</a></li>
            <li><a href="employer-completed">已完成任务</a></li>
        </ul></li>
        <li><a href="employer-contact"><i class="icon-envelope-alt"></i>联系我们</a></li>
        <li style="float:right" onclick="openM()"><a href="#"><i class="fa fa-envelope-open-o" aria-hidden="true"></i>信息</a></li>
    </ul>
</div>

<section class="panel-left">
    <h1>分块发布</h1>
    <div class="contact">
        <form action="#" method="post" name="cForm">
            <ul>
                <li>
                    <label>任务名</label>
                    <input id="taskName" type="text" name="taskname" placeholder="Taskname">
                </li>
                <li>
                    <label>图片类型</label>
                    <input id="pictureType" type="text" name="pictureType"  placeholder="PictureType" readonly>
                    <button id="addType" type="button" class="btn btn-success">添加</button>
                    <button id="clearType" type="button" class="btn btn-success clearBtn">清空</button>
                </li>
                <li>
                    <label>时限(时)</label>
                    <input id="limitTime" type="number" name="timeLimit" placeholder="TimeLimit">
                </li>
                <li>
                    <label>人数限制</label>
                    <input id="neededEmployee" type="number" name="num" placeholder="Num">
                </li>
                <li>
                    <label>任务描述</label>
                    <textarea id="marks" rows="6" cols="30"></textarea>
                </li>
                <li>
                    <label>任务奖励</label>
                    <input id="awards" type="number" name="bonus" placeholder="（请输入奖励额度）">
                </li>
            </ul>
        </form>
        <button id="releaseTask" type="button" class="btn btn-success butt">任务发布</button>
    </div>
</section>

<div class="panel-rightTop">
    <div class="container">
        <label>整体标注</label>
        <button class="btn btn-success" id="add1">添加图片</button>
        <button class="btn btn-success butt1" id="select1">清空图片</button>
        <input type="file" id="file_input1" multiple/>
    </div>
</div>

<div class="panel-rightMiddle">
    <div class="container">
        <label>方框标注</label>
        <button class="btn btn-success" id="add2">添加图片</button>
        <button class="btn btn-success" id="select2">清空图片</button>
        <input type="file" id="file_input2" multiple/>
    </div>
</div>

<div class="panel-rightBottom">
    <div class="container">
        <label>区域标注</label>
        <button class="btn btn-success" id="add3">添加图片</button>
        <button class="btn btn-success" id="select3">清空图片</button>
        <input type="file" id="file_input3" multiple/>
    </div>
</div>
<script>
	 $('#clearType').click(function () {
        document.getElementById("pictureType").value="";
    })
</script>
<script>
    var taskId="";
    $('#addType').click(function () {
        var types=document.getElementById("pictureType").value.split("/");
        if(types.length>=5){
            swal("无法添加","类型标签已满","error");
            return;
        }
        swal({
                title: "请选择要添加的类型标签",
                subtitle:"sss",
                text: "    <select id='type' class=\"sel\">\n" +
                "        <option>请选择</option>\n" +
                "        <option>自然</option>\n" +
                "        <option>动物</option>\n" +
                "        <option>植物</option>\n" +
                "        <option>建筑</option>\n" +
                "        <option>人物</option>\n" +
                "        <option>交通</option>\n" +
                "        <option>文化</option>\n" +
                "        <option>艺术</option>\n" +
                "        <option>卡通</option>\n" +
                "        <option>影视</option>\n" +
                "        <option>军事</option>\n" +
                "        <option>生活</option>\n" +
                "        <option>体育</option>\n" +
                "        <option>时尚</option>\n" +
                "        <option>科技</option>\n" +
                "        <option>其它</option>\n" +
                "    </select><br>",
                html: true,
                closeOnConfirm: false,
                showCancelButton:true,
            },
            function() {
                var types=document.getElementById("pictureType").value.split("/");
                var index=document.getElementById("type").selectedIndex;
                if(index==0){
                    swal.showInputError("请选择类型标签");
                }
                else {
                    var select = document.getElementById("type").options[index].value;
                    if (types.indexOf(select) >= 0) {
                        swal.showInputError("该类型标签已存在");
                        return false;
                    }
                    else if(document.getElementById("pictureType").value==""){
                        document.getElementById("pictureType").value+=select;
                        swal("添加成功", "标注已添加", "success");
                    }
                    else {
                        document.getElementById("pictureType").value = document.getElementById("pictureType").value + "/" + select;
                        swal("添加成功", "标注已添加", "success");
                    }
                }
            });
    })
    $('#releaseTask').click(function () {
        getTaskId();
        var pictureCode=[];
        var totalPictureAmount=0;
        var overallPictureId=[];
        var rectanglePictureId=[];
        var boundaryPictureId=[];
        for(var count = 0; count < dataArr1.length; count++){
            var pic = {
                pictureId:dataArr1[count].name,
                pictureBase64Code:dataArr1[count].base64
            };
            pictureCode.push(pic);
            overallPictureId.push(dataArr1[count].name);
            totalPictureAmount++;
        }
        for(var count = 0; count < dataArr2.length; count++){
            var pic = {
                pictureId:dataArr2[count].name,
                pictureBase64Code:dataArr2[count].base64
            };
            pictureCode.push(pic);
            rectanglePictureId.push(dataArr2[count].name);
            totalPictureAmount++;
        }
        for(var count = 0; count < dataArr3.length; count++){
            var pic = {
                pictureId:dataArr3[count].name,
                pictureBase64Code:dataArr3[count].base64
            };
            pictureCode.push(pic);
            boundaryPictureId.push(dataArr3[count].name);
            totalPictureAmount++;
        }
        var isFull=false;
        var taskName=document.getElementById("taskName").value;
        var employerId=localStorage.getItem("userId");
        var releaseType="分块发布";
        var startTime="";
        var limitTime=document.getElementById("limitTime").value;
        var neededEmployeeAmount=document.getElementById("neededEmployee").value;
        var award=document.getElementById("awards").value;
        var appointedEmployeeId=[];
        var marks=document.getElementById("marks").value;
        var pictureType=document.getElementById("pictureType").value;
        if(taskName==""){
            swal("发布失败","任务名不能为空","warning");
        }
        else if(pictureType==""){
            swal("发布失败","图片类型不能为空","warning");
        }
        else if(limitTime==""||(parseInt(limitTime)<=0)||(parseInt(limitTime)>=1000)){
            swal("发布失败","限制时间必须在0-999小时内","warning");
        }
        else if(neededEmployeeAmount==""||(parseInt(neededEmployeeAmount)<=4)||(parseInt(neededEmployeeAmount)>=1000)){
            swal("发布失败","限制人数必须在5-999内","warning");
        }
        else if(award==""||(parseInt(award)<=0)||(parseInt(award)>=10000)){
            swal("发布失败","奖励必须在0-9999内","warning");
        }
        else if(pictureCode.length==0){
            swal("发布失败","请添加图片后再发布","warning");
        }
        else {
            var taskType=pictureType.split("/");
            var pictureAcceptedTimes=[];
            for(var i = 0; i < totalPictureAmount; i++){
                pictureAcceptedTimes.push(0);
            }
            var task = {
                isFull: isFull,
                taskId: taskId,
                taskName: taskName,
                taskType:taskType,
                employerId: employerId,
                releaseType: releaseType,
                startTime: startTime,
                limitTime: limitTime,
                neededEmployeeAmount: neededEmployeeAmount,
                totalPictureAmount: totalPictureAmount,
                award: award,
                overallPictureId: overallPictureId,
                rectanglePictureId: rectanglePictureId,
                boundaryPictureId: boundaryPictureId,
                pictureAcceptedTimes:pictureAcceptedTimes,
                appointedEmployeeId: appointedEmployeeId,
                marks: marks
            };
            var taskInfo = {
                pictureCode: pictureCode,
                task: task
            };
            swal({
                    title: "确定发布该任务吗",
                    text: "点击确认进行发布",
                    type: "warning",
                    cancelButtonText:"取消",
                    confirmButtonText:"确认",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    showLoaderOnConfirm: true
                },
                function(){
                    $.ajax({
                        type: 'POST',
                        url: "/EmployerTask/release",
                        contentType: "application/json",
                        data: JSON.stringify(taskInfo),
                        success: function (result) {
                            if (result == true) {
                                setTimeout(function(){
                                    swal("发布成功","任务信息已更新","success");
                                }, 1500);
                            } else {
                                alert("发布失败");
                                setTimeout(function() {
                                    window.location.reload();
                                },1000);
                            }
                        },
                        error: function (result) {
                            alert("error");
                        }
                    });
                });
        }
    });

    function getTaskId() {
        $.ajax({
            type: 'POST',
            url:"/EmployerTask/getNewTaskId",
            async: false,                         //将ajax改为同步模式
            data: {},
            success:function(result){
                taskId=result;
            },
            error:function(result){
                alert("error");
            }
        });
    }
</script>

<section id="messageP" class="panelM none">
    <div class="contentM">
        <ul class="venus-menuM">
            <li class="active"><a href="#">未读</a></li>
            <li><a href="#">已读</a></li>
        </ul>
    </div>
    <div id='messageBox' class="scroll"></div>
    <div>
        <a id="read" class="btn2" onclick="readButton()">
            全部标为已读
        </a>
    </div>
</section>
</body>
</html>