<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>employee-home</title>
    <link href="css/zzsc.css" rel="stylesheet">
    <link href="css/maps.css" rel="stylesheet">
    <link href="fonts/css/font-awesome.css" rel="stylesheet">
    <link href="fonts/fonts/fontawesome-webfont.ttf" rel="stylesheet">
    <link href="fonts/fonts/fontawesome-webfont.woff" rel="stylesheet">
    <link href="fonts/fonts/fontawesome-webfont.woff2" rel="stylesheet">
    <script type="text/javascript" src="js/message.js"></script>
    <link href="css/message.css" rel="stylesheet">
    <script src="js/sweetalert.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/sweetalert.css">
    <script type="text/javascript" src="js/maps.js"></script>
    <script type="text/javascript" src="js/google.js"></script>
    <script src="js/sweetalert.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/sweetalert.css">
    <script type="text/javascript">$(document).ready(function(){$().maps();});</script>
    <script type="text/javascript">$(function (){
        $('#nky2 li:not(#nky2 li:last)').click(function (){
            $('.active').removeClass('active');
            $(this).addClass("active");
        });
        $('.venus-menuM li').click(function(){
            $('.venus-menuM li.active').removeClass('active');
            $(this).addClass("active");
            var mode=document.getElementById('read').innerText;
            document.getElementById('read').innerText=(mode=='全部标为已读')?'删除已读':'全部标为已读';
            if(mode=="全部标为已读"){
                document.getElementById('read').innerText='删除已读';
                refreshRead();
            }
            else{
                document.getElementById('read').innerText='全部标为已读';
                refreshNew();
            }
        });
    })
    </script>
</head>
<style>
    #message{
        margin-left:30px;
    }
    #cvs{
        margin:20px 40px;
        border:1px solid #AAAAAA;
    }
    p.lead{
        color: #333;
        font-style: italic;
        margin-bottom: 30px;
    }
    .btnp{
        margin-top:0px;
    }
    .btn {
        cursor:pointer;
        color: white;
        margin-top:10px;
        margin-left:90px;
        background: rgb(48, 35, 174);
        font-size: 16px;
        line-height: 38px;
        height: 38px;
        padding: 0 20px;
        border-radius: 3px;
        display: inline-block;
        text-decoration: none;
        transition: background .15s;
    }
    .btn:hover {
        background-color: rgb(81, 67, 224);
    }
    #type1[type=text]{
        margin-left:30px;
        width:220px;
        height:40px;
        border:1px solid #AAAAAA;
        border-radius:10px;
        padding:3px 8px;
    }
    #type1[type=text]{
        transition: .30s;
    }
    #type1[type=text]:focus{
        border-color:green;
    }
    .container{
        width:95%;
        position:absolute;
        margin-left:50px;
        margin-right:50px;
        margin-top:100px;
        display:-webkit-box;
        display:-moz-box;
    }
    div #left,#right,#middle{
        -webkit-border-radius:5px;
        -moz-border-radius:5px;
        border-radius:5px;
        height:100%;
    }
    #left,#right{
        width:330px;
        -webkit-box-sizing:border-box;
        -moz-box-sizing:border-box;
        padding:20px;
    }
    #middle{
        border-left:darkgray 4px solid;
        border-right:darkgray 4px solid;
        padding:20px;
        -webkit-box-flex:1;
        -moz-box-flex:1;
        -webkit-box-ordinal-group:2;
        -moz-box-ordinal-group:2;
        margin:0 5px;
    }
    #right{
        -webkit-box-ordinal-group:2;
        -moz-box-ordinal-group:2;
    }
    #pictureTag{
        width:200px;
        margin-left:30px;
        height:100px;
    }
    table {
        width: 276px;
        font-family:"Trebuchet MS", Arial, Helvetica, sans-serif;
        padding:20px;
        border-collapse:collapse;
    }
    table thead  tr {
        display: block;
    }
    table #tbody1 {
        display: block;
        height: 200px;
        overflow: auto;
    }
    table #tbody2{
        display: block;
        height:300px;
        overflow: auto;
    }
    table #tbody3{
        display:block;
        height:100px;
        overflow:auto;
    }
    table thead th {
        width: 200px;
        text-align:left;
        font-size:1.2em;
        padding-left:10px;
        padding-top:10px;
        padding-bottom:10px;
        background-color:#A7C942;
        color:#ffffff;
    }
    table thead th + th {
        width: 76px;
    }
    table tbody td {
        width: 200px;
        text-align:left;
        font-size:1.1em;
        border:1px solid #98bf21;
        padding:3px 7px 2px 7px;
    }
    table tbody td + td {
        width: 60px;
    }
    table tr.alt td
    {
        color:#000000;
        background-color:#EAF2D3;
    }
    .info{
        text-align: left;
        font-size: 20px;
        font-style: italic;
    }
    .content>ul>li:last-child>ul>li>a{
        width:300px;
        font-size:10px;
        float:right;
    }
</style>
<body>

<div style="text-align:center;clear:both">
    <script src="/gg_bd_ad_720x90.js" type="text/javascript"></script>
    <script src="/follow.js" type="text/javascript"></script>
</div>
<div class="content">
    <ul id="nky2" class="venus-menu">
        <li><a href="employee-home"><i class="icon-home"></i>主页</a></li>
        <li><a href="#"><i class="icon-user"></i>个人</a><ul>
            <li><a href="employee-info">个人信息</a></li>
            <li><a href="employee-data">统计信息</a></li>
        </ul></li>
        <li><a href="#"><i class="icon-tasks"></i>任务</a><ul>
            <li><a href="employee-newTask">接收新任务</a></li>
            <li><a href="employee-underway">进行中任务</a></li>
            <li><a href="employee-completed">已完成任务</a></li>
        </ul></li>
        <li  class="active"><a href="employee-canvas"><i class="icon-pencil"></i>画布</a></li>
        <li><a href="employee-contact"><i class="icon-envelope-alt"></i>联系我们</a></li>
        <li style="float:right" onclick="openM()"><a href="#"><i class="fa fa-envelope-open-o" aria-hidden="true"></i>信息</a></li>
    </ul>
</div>
<script>
    var selectedPictureID;
    var selectedTagID="";

    var pictureID="";
    var tagID="";
    var border=[];
    var annotation="";
    var imgs=new Image();
    var startTime=new Date();
    function PictureTag(pictureID, tagID, border, annotation) {
        this.pictureID = pictureID;
        this.tagID = tagID;
        this.border = border;
        this.annotation = annotation;
    }
    function Examination(examId,overallPictureId,answer){
        this.examId=examId;
        this.overallPictureId=overallPictureId;
        this.answer=answer;
    }
</script>

<script>
    function AddRow1(id,finish){
        var tbody=document.getElementById("tbody1");
        var row = document.createElement('tr'); //创建行
        var idCell = document.createElement('td'); //创建第一列id
        idCell.innerHTML = id; //填充数据
        row.appendChild(idCell); //加入行 ，下面类似
        var finishCell = document.createElement('td');//创建第二列name
        finishCell.innerHTML = finish;
        row.appendChild(finishCell);
        tbody.appendChild(row);
        var trs=document.getElementsByTagName('tr');
        for(var i=1;i<trs.length;i++){
            trs[i].onmouseover=function(){over()};
            trs[i].onclick=function(){change()};
            trs[i].onmouseout=function(){out()};
        }
    }
    function AddRow2(name,finish){
        var tbody=document.getElementById("tbody2");
        var row = document.createElement('tr'); //创建行
        var nameCell = document.createElement('td'); //创建第一列id
        nameCell.innerHTML = name; //填充数据
        row.appendChild(nameCell); //加入行 ，下面类似
        var finishCell = document.createElement('td');//创建第二列name
        finishCell.innerHTML = finish;
        row.appendChild(finishCell);
        tbody.appendChild(row);
        var trs=document.getElementsByTagName('tr');
        for(var i=1;i<trs.length;i++){
            trs[i].onmouseover=function(){over()};
            trs[i].onclick=function(){change()};
            trs[i].onmouseout=function(){out()};
        }
    }
    function AddRow3(name){
        var tbody=document.getElementById("tbody3");
        var row = document.createElement('tr'); //创建行
        var nameCell = document.createElement('td'); //创建第一列id
        nameCell.innerHTML = name; //填充数据
        row.appendChild(nameCell);
        tbody.appendChild(row);
        var trs=document.getElementsByTagName('tr');
        for(var i=1;i<trs.length;i++){
            trs[i].onmouseover=function(){over()};
            trs[i].onclick=function(){change()};
            trs[i].onmouseout=function(){out()};
        }
    }
    function clearTable1() {
        var parNode = document.getElementById("task"); //定位到table上
        var tbody= document.getElementById("tbody1");
        parNode.removeChild(tbody);
        var newBody=document.createElement('tbody');
        newBody.id="tbody1";
        parNode.appendChild(newBody);
    }
    function clearTable2(){
        var parNode = document.getElementById("picture"); //定位到table上
        var tbody= document.getElementById("tbody2");
        parNode.removeChild(tbody);
        var newBody=document.createElement('tbody');
        newBody.id="tbody2";
        parNode.appendChild(newBody);
    }
    function clearTable3(){
        var parNode = document.getElementById("pictureTag"); //定位到table上
        var tbody= document.getElementById("tbody3");
        parNode.removeChild(tbody);
        var newBody=document.createElement('tbody');
        newBody.id="tbody3";
        parNode.appendChild(newBody);
    }
</script>


<section>
    <div class="container">
        <div id="middle">
            <canvas id="cvs" width=900px height=720px></canvas>
        </div>
        <div id="left">
            <div class="content1">
                <div class="info">
                    <p>选择任务：</p>
                </div>
                <table id="task">
                    <thead>
                    <tr>
                        <th>任务名</th>
                        <th>完成</th>
                    </tr>
                    </thead>
                    <tbody id="tbody1"></tbody>
                </table>
            </div>

            <div class="content2">
                <div class="info">
                    <p>选择图片：</p>
                </div>
                <table id="picture">
                    <thead>
                    <tr>
                        <th>图片名</th>
                        <th>进度</th>
                    </tr>
                    </thead>
                    <tbody id="tbody2"></tbody>
                </table>
            </div>
        </div>
        <div id="right">
            <div class="info">
                <p>当前标注：</p>
            </div>
            <table id="pictureTag">
                <thead>
                <tr>
                    <th>标注</th>
                </tr>
                </thead>
                <tbody id="tbody3"></tbody>
            </table>
            <div class="info">
                <p>标注类型：</p>
            </div>
            <input id="type1" type="text" name="type" placeholder="无标注" readonly>
            <div class="info">
                <p>图片注解：</p>
            </div>
            <textarea id="message" rows="10" cols="25" placeholder="无" readonly></textarea>
            <p class="btnp">
                <a class="btn" id="modify">
                    修改标注
                </a>
                <a class="btn" id="delete">
                    删除标注
                </a>
                <a class="btn" id='save' >
                    保存标注
                </a>
                <a class="btn" id='submit' >
                    提交
                </a>
            </p>
        </div>
    </div>
</section>

<section id="messageP" class="panelM none">
    <div class="contentM">
        <ul class="venus-menuM">
            <li class="active"><a href="#">未读</a></li>
            <li><a href="#">已读</a></li>
        </ul>
    </div>
    <div id='messageBox' class="scroll"></div>
    <div>
        <a id="read" class="btn2" onclick="readButton()">
            全部标为已读
        </a>
    </div>
</section>
</body>

<script>
    var trs=document.getElementsByTagName('tr');
    for(var i=1;i<trs.length;i++){
        trs[i].onmouseover=function(){over()};
        trs[i].onclick=function(){change()};
        trs[i].onmouseout=function(){out()};
    }
    function examine(border) {
        this.border = border;
        var len = this.border.length;
        if (len == 2) {
            //alert("sss");
            var oCanvas = document.getElementById('cvs');
            var oGc = oCanvas.getContext('2d');
            oGc.strokeStyle = "red";
            oGc.beginPath();
            oGc.strokeRect(border[0].x, border[0].y, border[1].x - border[0].x, border[1].y - border[0].y);
            oGc.closePath();
        } else if (len > 2) {
            var oCanvas = document.getElementById('cvs');
            var oGc = oCanvas.getContext('2d');
            for (var i = 0; i < len - 1; i++) {
                oGc.beginPath();
                oGc.moveTo(border[i].x , border[i].y);
                oGc.lineTo(border[i+1].x, border[i+1].y);
                oGc.stroke();
                oGc.closePath();
            }
        }
    }
    function getSelectedTagIndex(){
        var table=document.getElementById('pictureTag');
        for(var i=1; i<table.rows.length; i++)   {
            if(table.rows[i].tag == true)
                return i-1;
        }
    }
    function getSelectedPictureIndex(){
        var table=document.getElementById('picture');
        for(var i=1; i<table.rows.length; i++)   {
            if(table.rows[i].tag == true)
                return i-1;
        }
    }
    function changePicture(pictureID){
        save=null;
        selectedPictureID=pictureID;
        selectedTagID="";
        document.getElementById('type1').value='整体标注';
        document.getElementById("message").value = "";
        var cvs = document.getElementById("cvs");
        var cxt = cvs.getContext("2d");
        imgs = new Image();
        var pictureCode="";
        //show picture
        $.ajax({
            type: 'POST',
            url:"/EmployeeTask/getPictureBase64Code",
            data: {
                taskId:'exam',
                pictureId:selectedPictureID
            },
            success:function(result){
                pictureCode=result;
                imgs.onload = drawImg;//图片加载完成再执行
                function drawImg(){
                    cxt.drawImage(imgs,0,0,cvs.width,cvs.height);
                }
                imgs.src = pictureCode;
            },
            error:function(result){
                alert("error");
            }
        });
       //添加tag
        clearTable3();
        if(saves[selectedPictureID]!=null){
            AddRow3(saves[selectedPictureID].tagID);
        }
        draw("整体标注");
    }

    function changePictureTag(rowIndex){
        document.getElementById('message').value=saves[selectedPictureID].annotation;
        selectedTagID = saves[selectedPictureID].tagID;
        var cvs = document.getElementById("cvs");
        var cxt = cvs.getContext("2d");
        cxt.clearRect(0, 0, cvs.width, cvs.height);
        cxt.drawImage(imgs, 0, 0, cvs.width, cvs.height);
        examine(saves[selectedPictureID].border);
    }
    //鼠标点击选择行时候变色
    function change() {
        var oObj = window.event.srcElement;
        //alert(change.tagName.toLowerCase());
        if(oObj.tagName.toLowerCase() == "td"){
            var oTr = oObj.parentNode;
            var table=oTr.parentNode.parentNode;
            for(var i=1; i<table.rows.length; i++)   {
                table.rows[i].style.backgroundColor   =   "";
                table.rows[i].tag = false;
            }
            oTr.style.backgroundColor = '#ffccff';
            oTr.tag = true;
            if(table.id=="picture"){
                changePicture(oTr.children[0].innerHTML);
            }
            else if(table.id=='pictureTag'){
                changePictureTag(oTr.rowIndex-1);
            }
        }
    }
    //鼠标点击另外一行时关闭已选行变色
    function out() {
        var oObj = event.srcElement;
        if(oObj.tagName.toLowerCase() == "td"){
            var oTr = oObj.parentNode;
            if(!oTr.tag) oTr.style.backgroundColor = "";
        }
    }
    //鼠标移动到选择行上时的行变色
    function over(){
        var oObj = event.srcElement;
        if(oObj.tagName.toLowerCase() == "td"){
            var oTr = oObj.parentNode;
            if(!oTr.tag) oTr.style.backgroundColor = "#ffccff";
        }
    }
</script>
<script>
    var employeeId = localStorage.getItem("userId");
    var saves=new Array(10);
    var save;
    var overallPictureId=[];

    showExam();
    function showExam() {
        $.ajax({
            type: 'POST',
            url:"/Examination/getExam",
            async: false,                         //将ajax改为同步模式
            data: {
                examId:'exam'
            },
            success:function(result){
                overallPictureId=result.overallPictureId;
                AddRow1(result.examId,"0/"+overallPictureId.length);
                for(var count = 0; count < overallPictureId.length; count++){
                    AddRow2(overallPictureId[count], "未完成");
                }
            },
            error:function(result){
                alert("error");
            }
        });
    }
</script>
<script>
    function draw(type){
        if(selectedPictureID==""){
            return;
        }
        document.getElementById('cvs').onmousedown = null;
        document.getElementById('cvs').onmouseup = null;
        var oCanvas = document.getElementById('cvs');
        var oGc = oCanvas.getContext('2d');
        if(type=="整体标注") {
            if(document.getElementById('pictureTag').rows.length>1){
                return;
            }
            oCanvas.onmousedown = function (ev) {
                var ev = ev || event;
                var startX = ev.offsetX;
                var startY = ev.offsetY;
                oCanvas.onmouseup = function (ev) {
                    var ev = ev || event;
                    oCanvas.onmousemove = null;
                    oCanvas.onmouseup = null;
                    oCanvas.onmousedown=null;
                    var endX = ev.offsetX;
                    var endY = ev.offsetY;
                    oGc.strokeStyle = "red";
                    if (Math.abs(endX - startX) > 10 && Math.abs(endY - startY) > 10) {
                        oGc.beginPath();
                        oGc.strokeRect(startX, startY, endX - startX, endY - startY);
                        oGc.closePath();
                        var startPoint = {"x": startX, "y": startY};
                        var endPoint = {"x": endX, "y": endY};
                        var border = [startPoint, endPoint];
                        var pictureID=selectedPictureID;
                        var tagID=selectedPictureID;
                        setTimeout( (function(){
                                //annotation=prompt("请输入图片注解");
                                swal({
                                        title: "输入图片注解",
                                        text: "请输入当前图片标识的注解",
                                        type: "input",
                                        closeOnConfirm: false,
                                        inputPlaceholder: "请填写注解",
                                        allowEscapeKey:false
                                    },
                                    function(inputValue){
                                        if (inputValue === false) return false;

                                        if (inputValue === "") {
                                            swal.showInputError("图片注解不得为空");
                                            return false
                                        }
                                        annotation=inputValue;
                                        swal("标注成功", "标注成功", "success");
                                        save = new PictureTag(pictureID, tagID, border, annotation);
                                        document.getElementById('message').value=annotation;
                                    });
                            }
                        ),50);
                    }
                }
            }
        }
    }
</script>
<script>
    document.getElementById('save').onclick=function(){
        if(save==null){
            swal("当前无法保存","请选择要保存的标注","warning");
        }
        else {
            swal({
                    title: "确定保存对该图片进行的标注吗",
                    text: "点击确认将标注保存到本地",
                    type: "warning",
                    cancelButtonText: "取消",
                    confirmButtonText: "确认",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    showLoaderOnConfirm: true
                },
                function () {
                    saves[save.pictureID]=save;
                    clearTable3();
                    AddRow3(save.tagID);
                    var cell1 = document.getElementById('picture').rows[getSelectedPictureIndex() + 1].cells[1];
                    var cell2 = document.getElementById('task').rows[1].cells[1];
                    if (cell1.innerHTML == '未完成') {
                        cell1.innerHTML = '已完成';
                        cell2.innerHTML = (parseInt(cell2.innerHTML.split('/')[0]) + 1) + "/" + cell2.innerHTML.split('/')[1];
                    }
                    setTimeout(function () {
                        swal("保存成功", "标注信息已更新", "success");
                    }, 1500);
                });
        }
    };
    document.getElementById('delete').onclick=function(){
        if(selectedTagID==""){
            swal("当前无法删除","请选择要删除的标注","warning");
        }
        else{
            saves[selectedPictureID]=null;
            save=null;
            clearTable3();
            setTimeout(function(){
                swal("删除成功","标注信息已更新","success");
            }, 1500);
            var cvs = document.getElementById("cvs");
            var cxt = cvs.getContext("2d");
            cxt.clearRect(0, 0, cvs.width, cvs.height);
            cxt.drawImage(imgs, 0, 0, cvs.width, cvs.height);
            document.getElementById('message').value="";
            draw(document.getElementById("type1").value);
        }
    };
    document.getElementById('modify').onclick=function() {
        if (selectedTagID == "") {
            swal("当前无法修改", "请选择要修改的标注", "warning");
        }
        else {
            swal({
                    title: "修改图片注解",
                    text: "请输入新的图片注解",
                    type: "input",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    inputPlaceholder: "请填写注解"
                },
                function (inputValue) {
                    if (inputValue === false) return false;

                    if (inputValue === "") {
                        swal.showInputError("图片注解不得为空");
                        return false
                    }
                    document.getElementById('message').value = inputValue;
                    saves[getSelectedTagIndex()].annotation = inputValue;
                    swal("修改成功", "图片注解已更新(请及时保存)", "success");
                });
        }
    };
        document.getElementById('submit').onclick = function () {
            var time=(new Date()-startTime)/1000;
            var completed=0;
            for(var i=0;i<saves.length;i++){
                if(saves[i]!=null){
                    completed++;
                }
            }
            if(completed<overallPictureId.length){
                swal("不可提交","您尚有图片未完成","error");
                return;
            }
            swal({
                    title: "确定提交该结果吗",
                    text: "点击确认进行提交",
                    type: "warning",
                    cancelButtonText: "取消",
                    confirmButtonText: "确认",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    showLoaderOnConfirm: true
                },
                function () {

                var exam = {
                    employeeId: employeeId,
                    examId: 'exam',
                    paper: saves,
                    time:Math.round(time)
                };
                    $.ajax({
                        type: 'POST',
                        url: "/Examination/judgeExam",
                        contentType: "application/json",
                        data: JSON.stringify(exam),
                        success: function (result) {
                            if (result >= 60) {
                                setTimeout(function () {
                                    swal("考核通过", "您的入门考核分数为：" + Math.round(result), "success");
                                    setTimeout(function () {
                                        window.location.href = 'employee-home';
                                        window.event.returnValue = false;
                                    }, 3000);
                                }, 1500);
                            } else {
                                setTimeout(function () {
                                    swal("考核未通过", "您的入门考核分数为：" + Math.round(result), "error");
                                    setTimeout(function () {
                                        window.location.href = 'employee-home';
                                        window.event.returnValue = false;
                                    }, 3000);
                                }, 1500);
                            }
                        },
                        error: function (result) {
                            alert("error");
                        }
                    });
                });
        }
</script>

</html>